define first_time_magic_tower = True

label magic_tower_elsa:
    if first_time_magic_tower:
        $ first_time_magic_tower = False
        jump magic_tower_first_visit
    else:
        jump magic_tower_with_elsa_no_blessing

label magic_tower_first_visit:
    scene bg magic_tower_enterence with fade

    "Передо мной возвышалась гигантская магическая башня."
    "Она не выглядела древней — её стены словно впитали в себя магию и время."
    "Огромные каменные плиты покрывались тонкими линиями светящихся рун, медленно меняющих цвет. Казалось, башня дышит магией."
    "Чем ближе я подходил, тем сильнее ощущал странное покалывание в воздухе. Это место буквально бурлило энергией."

    #show e neutral at center with dis5
    e "Не зевай. Идём внутрь."
    scene bg magic_tower with fade

    "Мы вошли внутрь."
    "Вокруг множество непонятного, не поддающегося логике, лестицы ведущие в никуда, и множество развилок путей." 
    "Мы словно зашли в лабиринт, в котором ориентироваться надо не на зрение, а на другие, какие-то внутренние ощущения."
    "Воздух был наполнен ароматом древних книг и чего-то едва уловимо, сладкого... возможно, магии."
    "Я буквально ощущал, как энергия течёт сквозь эти стены."

    show mer neutral at center with dissolve
    p "!!!!!"
    "Но моё восхищение прервала женщина, вставшая прямо перед нами."
    "Высокая, с длинными чёрными волосами, холодным, но проницательным взглядом."
    "Она с ухмылкой посмотрела на меня."
    mind "Почему у нее такое откровенное платье?"

    mer surprised "[hero_name] выглядит так, будто впервые видит магию." with dissolve 

    #show e smirk at right_mid with dis5
    e "Не просто впервые — он вообще понятия не имеет, что это такое."
    p "Эй! Я хотя бы слышал про магию!"
    mer smirk "О, слышал? Какая редкость. Давай проверим, что ты знаешь." with dissolve 

    "Ух, мне не нравится этот её тон."

    ### ПЕРВАЯ ПРОВЕРКА: ОСНОВЫ МАГИИ  
    mer "Итак, первый вопрос. Что является основой любого магического заклинания?"
    menu:
        "Магическая палочка?":
            p "Магическая палочка!"
            show mer sigh with dissolve 
            mer "О боги… Какой ужас. Нет."
        "Слова заклинания?":
            p "Наверное, слова заклинания?"
            show mer sigh with dissolve 
            mer "Я надеялась, что ты не настолько безнадёжен…"
        "Внутренняя магическая энергия?":
            p "Внутренняя магическая энергия!"
            show mer neutral with dissolve 
            mer "Хм… Верно, но я уверена, что ты сказал это наугад."
    "[mer.name] закатила глаза, явно не веря в мои способности."
    #show e smirk with dissolve 
    e "Я предупреждала."

    ### ВТОРАЯ ПРОВЕРКА: РАЗЛИЧИЕ ЭЛЕМЕНТОВ  
    mer "Ладно, следующий вопрос. Чем отличается огненная магия от воздушной?"
    menu:
        "Огонь горячий, а воздух нет?":
            p "Ну... Огонь горячий, а воздух нет?"
            show mer annoyed with dissolve 
            mer "Гениально. Никогда бы не догадалась. Спасибо, что просветил меня."
        "Огонь сжигает, а воздух помогает дышать?":
            p "Огонь сжигает, а воздух помогает дышать?"
            show mer smirk with dissolve 
            mer "Ты определённо мастер очевидных истин."
        "Огонь уничтожает, а воздух может направлять магию?":
            p "Ну… Огонь уничтожает, а воздух может направлять магические потоки?"
            show mer surprised with dissolve 
            mer "Хм… Ты хоть что-то понимаешь. Может быть, из тебя ещё что-то выйдет."
    #show e smirk with dissolve 
    e "Хотя бы одну догадку он угадал."

    ### ТРЕТЬЯ ПРОВЕРКА: ПРАКТИЧЕСКИЙ ЭКСПЕРИМЕНТ  
    mer "Последний тест. Покажи, что ты вообще можешь сделать с магией. Попробуй создать шар света."
    menu:
        "Попытаться сосредоточиться и представить свет":
            p "Я закрыл глаза и попытался представить шар света в своей ладони…"
            "..."
            "Ничего не произошло."
            show mer sigh with dissolve 
            mer "Ожидаемо."
        "Произнести какое-нибудь слово, как в книгах":
            p "Люмен! Люкс! Светоч! Дай мне свет!"
            "..."
            "Абсолютно ничего не произошло."
            show e laugh with dissolve 
            e "Ахахах! Может, тебе попробовать 'абракадабра'?"
        "Потрясти руками, вдруг сработает":
            p "Я резко вытянул руки и начал трясти ими, пытаясь вызвать хоть какой-то эффект."
            "..."
            "Ничего."
            show mer neutral with dissolve 
            mer "Ты выглядел так глупо, что я даже не знаю, смеяться или плакать."

    mer surprised "Поздравляю, ты полностью провалил все три проверки." with dissolve 
    p "Ну, я хотя бы пытался!"

    mer smirk "Да-да. Но в этот раз попытки не считаются. " with dissolve 
    mer smile "Хотя... Я чувствую, у тебя есть великий потенциал." with dissolve
    mer smirk "Где-то глубоко-глубоко под слоем бесполезности..." with dissolve

    e smirk "Я знала, что это будет весело." with dissolve 

    mer neutral "Ладно, раз уж [e.name] тебя сюда привела, я дам тебе шанс. " with dissolve 
    mer "Добро пожаловать в магическую башню. Но учти: ты на самом дне. "
    mer "И тебе придётся очень постараться, чтобы хоть немного подняться."

    "Я не был уверен, что мне это нравится, но выбора у меня не было."

    $ updateCanVisit("mt", True)
    jump magic_tower_hub

label magic_tower_with_elsa_no_blessing:
    hide e
    scene bg magic_tower with fade
    "Я оказался у входа в магическую башню. [e.name] шла рядом, не скрывая своего недовольства."
    p "Неужели я так плох?"
    e "Ты даже хуже, чем я ожидала. Но не волнуйся, у нас ещё есть время тебя исправить."

    show mer smirk with dissolve 
    mer "О, [hero_name], рада знакомству! Ты все же привела его."
    p "Все же привела?"
    mer "Вот и прекрасно. Значит, будешь слушать и мои уроки."
    p "Какие уроки? Меня не слышно?"
    mer "[e.name] почувствовала в тебе сильную энергию, а я пока сомневаюсь, но мы разовьем то, что в тебе есть."
    p "Но вы не спросили, хочу ли я обучаться!"
    mer annoyed "Хорошо... [hero_name], ты хочешь обучаться магии?" with dis5
    menu:
        "Да":
            mer smile "Вопрос решен. Пока подумай обо всем. Видимо тебе нужно время." with dis5
            $ updateCanVisit("mt", True)
            jump city
        "Нет":
            $ updateCanVisit("mt", False)
            $can_go_mer = False
            mer "Вот оно как..."
            $customNotify("Ты никогда не сможешь посетить магическую башню")
            mer "С такими я не желаю иметь дел!"
            "Ты внезапно перемещаешься в город"
            jump city

    jump magic_tower_hub

label magic_tower_alone:
    scene bg magic_tower with fade

    "Я стоял перед величественной магической башней. В отличие от прошлого раза, теперь Эльзы рядом не было."

    "Я вздохнул и толкнул тяжёлую дверь, войдя внутрь."

    show mer neutral with dissolve 
    mer "Ну-ну, кто это у нас? И без няньки в этот раз."

    p "Я решил прийти сам."

    mer "Хм, и с чего бы такая решимость? Или [e.name] просто выгнала тебя?"

    "Я не был уверен, стоит ли отвечать на это, но её пронизывающий взгляд давал понять, что лучше сказать правду."

    p "Я хочу научиться магии."

    show mer smirk with dissolve 
    mer "Посмотрим, насколько ты серьёзен. Здесь довольно много информации, но далеко не вся полезна. Искать теперь придется самостоятельно."
    mer "А мне пора бежать, если понадоблюсь..."
    mer "Думаю, ты сможешь меня найти."
    hide mer dissolve

    jump magic_tower_hub

label magic_tower_hub:
    scene bg magic_tower with fade
    hide e with dissolve 
    hide mer with dissolve 
    "Я могу исследовать магическую башню, изучая магию и выполняя задания наставницы."
    
    menu:
        "Исследовать магическую башню":
            jump explore_magic_tower

        "Найти [mer.name]":
            jump find_merlin

        "Найти [e.name]":
            jump find_elsa

        "Вернуться в город":
            jump city

# Исследование магической башни с шансом найти "Великую книгу для Дураков"
label explore_magic_tower:
    "Я решил исследовать магическую башню"

    $ luck = renpy.random.randint(1, 100)
    $ lib = renpy.random.randint(1, 100)
    if lib < 25:
        scene bg magic_library1 with fade
    if lib >= 25 and lib < 50:
        scene bg magic_library2 with fade
    if lib >= 50 and lib < 75:
        scene bg magic_library3 with fade
    if lib >= 75 and lib < 100:
        scene bg magic_library4 with fade

    "Здесь было полно загадочных комнат, пыльных полок с книгами и странных артефактов"
    "Я осмотрел одну из секций гигантской библиотеки"
    "Было потрачено немало времени на изучение книг"

    if luck > 95:  # 5% шанс найти легендарную книгу
        "Пролистывая одну из книжных полок, я наткнулся на потрёпанную книгу с нелепым названием: 'Великая книга для Дураков'."

        "Я осторожно открыл её, и вдруг почувствовал, как мощный поток энергии пронёсся через меня!"

        $minusMoneyPlusChar(0, ["intelligence"], 10)
        "Моя магическая энергия резко возросла! Кажется, я стал немного сильнее."
    
    else:
        "Я нашёл несколько старых свитков с записями о магии, но ничего особо ценного."
    jump magic_tower_hub
